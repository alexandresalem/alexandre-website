{% extends 'gamef1/base.html' %}
{% load static %}
{% load static %}

{% block content %}

    <div class="row" id="app-row">
        <div class="col"><h3 id="gamef1-title" class="text-center">Guess the F1 Car</h3></div>
    </div>
    <div class="row app-gamef1-container" id="app-gamef1-container-1">
        <div class="col"><p class="text-center">Upload a photo, and the algorithm will tell you which car is it.</p></div>
    </div>

    <div class="row justify-content-center" id="app-gamef1-container-2">
        <div class="col-m text-center">

            <form id="gamef1-initial-form" method="post" action="" enctype="multipart/form-data">


                {% csrf_token %}
                <input id="f1image" class="form-control mb-4" type="file" name="f1image">


                <button id="btnGuess" class="btn btn-primary mb-4" type="submit">Guess Car!</button>

            </form>

        </div>
    </div>
    {% if url %}
    <form id="gamef1-result-form" method="post" action="" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="row" id="result-container">

            <div class="col text-center">
                <h3 class="text-secondary">1st Guess</h3>
                <h4 id="first_team">.</h4>
                <p id="first_chassis">.</p>
                <input type="radio" name="guess" value="1st" id="id_guess_0" required>


            </div>
            <div class="col text-center">
                <h3 class="text-secondary">2nd Guess</h3>
                <h4 id="first_team_b">.</h4>
                <p id="second_chassis">.</p>
                <input type="radio" name="guess" value="1st" id="id_guess_1" required>
            </div>
            <div class="col text-center">
                <h3 class="text-secondary">3rd Guess</h3>
                <h4 id="third_team">.</h4>
                <p id="third_chassis">.</p>
                <input type="radio" name="guess" value="1st" id="id_guess_2" required>
            </div>

    </div>

    <div class="row mt-4">
        <div class="col text-center">
            <p>Select the right answer. Use the fields below if needed.</p>
            <select id="select-team" name="select-team">
              <option value="Select Construtor">Select Constructor</option>
            </select>
            <select id="select-chassis" name="select-chassis">
              <option value="Select Chassis">Select Chassis</option>
            </select>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col text-center">
            <button id="btnResult" class="btn btn-primary mb-4" type="submit">Submit Answer</button>
        </div>

    </div>
    </form>

    <div class="row">
        <div class="col text-center">
            <input type="text" name="link" value="{{url}}" style="display:none">
            <input type="text" name="chassis" value="" id="chassis" style="display:none">
            <input type="text" name="team" value="" id="team" style="display:none">
            <img id="gamef1-result" src="{{url}}" class="img-fluid mx-auto d-block">
            <script>
                 let image = document.getElementById('gamef1-result');
                 image.onload = async function htmlpredict(){

                    let f1_array = {{array|safe}};
                    console.log(f1_array);
                    const folders = await predict(image,f1_array);
                    console.log(folders);


                    let secondmodel;
                    async function loadSecondModel(folder){
                        secondmodel = await tf.loadLayersModel(folder);
                        console.log('Second Model Loaded');
                        let input = tf.tensor4d(f1_array,[1,50,50,3]);
                        secondpredictions = secondmodel.predict(input).dataSync();
                        console.log('Prediction completed.');
                        const chassis_predictions = secondpredictions.slice().sort();

                        let first_chassis_prediction = chassis_predictions[secondpredictions.length - 1];
                        let second_chassis_prediction = chassis_predictions[secondpredictions.length - 2];

                        let first_chassis_result = secondpredictions.indexOf(first_chassis_prediction);
                        let second_chassis_result = secondpredictions.indexOf(second_chassis_prediction);

                        const list = document.getElementById('first_team').innerHTML.replace(' ','_');
                        document.getElementById('first_chassis').innerHTML = dict[list][first_chassis_result];
                        document.getElementById('second_chassis').innerHTML = dict[list][second_chassis_result];

                        thirdmodel = await tf.loadLayersModel(folders[1]);
                        thirdpredictions = thirdmodel.predict(input).dataSync();
                        console.log(thirdpredictions);
                        let third_chassis_prediction = thirdpredictions.slice().sort()[thirdpredictions.length - 1];
                        console.log(third_chassis_prediction);
                        let third_chassis_result = thirdpredictions.indexOf(third_chassis_prediction);
                        console.log(third_chassis_result);
                        const list_b = document.getElementById('third_team').innerHTML.replace(' ','_');
                        console.log(list_b)
                        document.getElementById('third_chassis').innerHTML = dict[list_b][third_chassis_result];


                    }
                    loadSecondModel(folders[0]);
                     id_guess_0.addEventListener("click", function(){
                         document.getElementById("chassis").value = document.getElementById("first_chassis").innerHTML;
                         document.getElementById("team").value = document.getElementById("first_team").innerHTML;

                    });
                    id_guess_1.addEventListener("click", function(){
                         document.getElementById("chassis").value = document.getElementById("second_chassis").innerHTML;
                         document.getElementById("team").value = document.getElementById("first_team_b").innerHTML;

                    });
                    id_guess_2.addEventListener("click", function(){
                         document.getElementById("chassis").value = document.getElementById("third_chassis").innerHTML;
                         document.getElementById("team").value = document.getElementById("third_team").innerHTML;

                    });
                    loadSelectTeams();


                }

            </script>
        </div>
    </div>

    {% endif %}
{% endblock %}